<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
 	  layout:decorate="~{layout/layout}"> <!-- layout쓰겠다 & fragment도 아래 같이 가져와서 body전체를 div로 감싸기 -->
<head>
<meta charset="UTF-8">
<title>empMng.html(CRUD)</title>
</head>
<body>
 <div layout:fragment="content">
	<h3>사원목록</h3>
	<table>
		<thead>
			<tr>
				<th>NO.</th>
				<th>employee_id</th>
				<th>NAME</th>
				<th>hire_date</th>
				<th>salary</th>
				<th>보너스</th>
				<th>수정/삭제</th>
			</tr>
		</thead>
		<tbody id="emplist">
			<!-- ajax에선 thymeleaf th: 못 씀 -->
		</tbody>
	</table>
	
	<br>
	
	<h3>사원(등록, 조회)</h3>
	<!-- ajax는 form action속성 사용 X & button type="button"으로(아니면 기본 submit이라 실행X) -->
	<form method="post" name="frm"> 
		lastName <input name="lastName"><br><br>
		hireDate <input name="hireDate"><br><br>
		jobId <select name="jobId" >
				<option value="IT_PROG">Programmer</option>
				<option value="ST_MAN">Stock Manager</option>
			  </select><br><br>
		이메일 <input name="email">
		<button type="button" onclick="saveReq()">등록</button>
	</form>


<script>
/* ajax 요청 & 응답 세트로 */
//=================================================
//사원리스트 요청
listReq();

// 등록삭제 등 처리 후 append로 후처리 못 하겠으면? 리스트만 다시 불러오게 처리하기 위해 따로 함수로 만듦
function listReq() {
	fetch("/ajax/empList")
	.then(res => res.json())
	.then(res => listRes(res));
}


 
//사원리스트 응답
function listRes(res) {
	
	let i=0; // NO.
	for(empObj of res) {
		
		//button 조건
		let bonusBtn = '<button>신청</button>';
		if(empObj.salary > 10000) {
			bonusBtn = '<button>미신청</button>'; /* 밖에서 if문으로 만들고 아래 삽입 */
		}
		
		//table body 삽입
		let newTag = `
			<tr>
				<td>${++i}</td>
				<td onclick="infoReq(${empObj.employeeId})">${empObj.employeeId}</td>
				<td>${empObj.firstName} ${empObj.lastName}</td>
				<td>${dateFormat(empObj.hireDate)}</td>
				<td>${empObj.salary}</td>
				<td>${bonusBtn}</td>
				<td><button type="button" onclick="move(${empObj.employeeId})">조회</button></td> <!-- ajax에선 th: 못 씀 -->
			</tr>`
			
			emplist.innerHTML += newTag;
		}	
}
	
//날짜format
function dateFormat(dt) {
		console.log(dt);
		let date = new Date(dt);
		
		let year = date.getFullYear();
		let month = ( 1 + date.getMonth() );
		let day = date.getDate();
		
		month = month >= 10 ? month : '0' + month; //10미만일 시 앞에 0을 붙혀서 저장
		day = day >= 10 ? day : '0' + day;
		
		return `${year}년 ${month}월 ${day}일`;
}
//======================================================
//상세조회 요청
function infoReq(employeeId) {
	//fetch("/ajax/emp/" + employeeId)
	fetch(`/ajax/emp/${employeeId}`)
	.then(res => res.json())
	.then(res => infoRes(res))
}

//상세조회 응답
function infoRes(res) {
	//input태그에 해당 사원 정보 표시
	frm.lastName.value = res.lastName;
	frm.email.value = res.email;
	frm.hireDate.value = res.hireDate;
	frm.jobId.value = res.jobId;
}


//======================================================
//등록 요청 (3가지 방식)
//1.첫번째방법: queryString 직접 만들기
/* function saveReq() {
	const lastName = frm.lastName.value;
	const email = frm.email.value;
	const hireDate = frm.hireDate.value;
	const jobId = frm.jobId.value;
	
	let param = `lastName=${lastName}&email=${email}&hireDate=${hireDate}&jobId=${jobId}`
	fetch("/ajax/emp", { //데이터 있으면 fetch("url", option) -- 데이터는 body에 실어서
		method : "post",
		headers: {
		      "Content-Type": "application/x-www-form-urlencoded",
		    },
		body : param
		
	})
	.then(res => res.json())
	.then(res => saveRes(res))
} */

//2.두번째방법: formData 첨부파일도 가능
/* function saveReq() {
	let param = new FormData(document.frm);
	fetch("/ajax/emp", {
		method : "post",
		body : param	
	})
	.then(res => res.json())
	.then(res => saveRes(res))
} */

//3.세번째방법: json
function saveReq() {
	const lastName = frm.lastName.value;
	const email = frm.email.value;
	const hireDate = frm.hireDate.value;
	const jobId = frm.jobId.value;
	
	let param = {lastName, email, jobId, hireDate }
	fetch("/ajax/emp", { 
		method : "post",
		headers: {
			"Content-Type": "application/json",
		    },
		body : JSON.stringify(param)
		
	})
	.then(res => res.json())
	.then(res => saveRes(res))
}
		
//등록 응답
function saveRes(res) {
	//console.log(res)
	listReq();
}

</script>	

</div><!-- end layout:fragment -->
</body>
</html>

<style>
table, th, td {
	border: 2px solid #ccc;
	border-collapse: collapse;
	padding: 5px;
}
th {
	background: #eee
}

</style>